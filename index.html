<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>Absensi Siswa - Mobile</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<style>
:root{
  --bg:#f0f4f8; --card:#fff; --muted:#6b7280; --accent:#2563eb;
  --success:#16a34a; --danger:#dc2626; --text:#111;
}
[data-theme="dark"]{
  --bg:#111; --card:#1f1f1f; --muted:#aaa; --accent:#3b82f6;
  --success:#22c55e; --danger:#ef4444; --text:#f3f3f3;
}
body,html{margin:0; font-family:'Segoe UI',sans-serif; background:var(--bg); color:var(--text);}
body{background:linear-gradient(rgba(255,255,255,0.7), rgba(255,255,255,0.7)), url('background.jpg') no-repeat center center fixed; background-size: cover; transition:0.3s;}
body[data-theme="dark"]{background:linear-gradient(rgba(17,17,17,0.7), rgba(31,31,31,0.7)), url('background.jpg') no-repeat center center fixed;background-size: cover;}
body::after{content:"";position:fixed;top:50%;left:50%;width:300px;height:300px;background:url('sekolah-removebg-preview.png') no-repeat center center;background-size:contain;opacity:0.05;transform:translate(-50%,-50%);z-index:0;}
.container{ max-width:100%; margin:20px auto; padding:20px; background:var(--card); border-radius:16px; box-shadow:0 10px 25px rgba(0,0,0,.1); position:relative; z-index:1; overflow-x:auto;}
h1{margin:0 0 16px;font-size:2rem;color:var(--accent); text-align:center;}
h2{margin-top:16px;font-size:1.2rem;color:var(--accent);}
.muted{color:var(--muted); text-align:center; font-size:0.9rem;}
input,select,button{padding:10px 14px;border:1px solid #ccc;border-radius:12px;font-size:1rem; transition:0.3s;}
input:focus{border-color:var(--accent); outline:none; box-shadow:0 0 10px rgba(37,99,235,.3);}
button{cursor:pointer;background:var(--accent);color:#fff;border:none;box-shadow:0 6px 12px rgba(0,0,0,.15);}
button:hover{background:#1e40af;}
button.ghost{background:transparent;color:var(--accent);border:1px solid var(--accent);}
button.ghost:hover{background:var(--accent);color:#fff;}
table{width:100%;border-collapse:collapse;margin-top:12px;}
th,td{padding:10px;border:1px solid #ccc;text-align:left; font-size:0.9rem;}
th{background:#eee;}
.row{display:flex;flex-wrap:wrap;gap:10px;margin:10px 0;justify-content:center;}
.toast{position:fixed;bottom:20px;right:20px;padding:12px 20px;border-radius:12px;color:#fff; box-shadow:0 6px 20px rgba(0,0,0,.2);opacity:0;transform:translateY(20px); transition:all 0.4s;}
.toast.show{opacity:1;transform:translateY(0);}
.pop{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%); width:100px;height:100px;border-radius:50%;display:flex;align-items:center; justify-content:center;font-size:48px;color:#fff;opacity:0;pointer-events:none;transition:all 0.5s;}
.pop.show { animation: bouncePop 0.5s ease forwards; }
.pop.success{background:var(--success);}
.pop.fail{background:var(--danger);}
@keyframes bouncePop{0%{transform:translate(-50%,-50%) scale(0.5);opacity:0;}50%{transform:translate(-50%,-50%) scale(1.2);opacity:1;}80%{transform:translate(-50%,-50%) scale(0.95);}100%{transform:translate(-50%,-50%) scale(1);}}
#loginPage{display:flex;flex-direction:column;justify-content:center;align-items:center;height:100vh;padding:10px;}
#loginPage input#loginCode{width:80%; font-size:1.2rem; text-align:center;}
.dark-toggle{position:fixed;top:10px;right:10px;padding:6px 10px;border-radius:8px;background:var(--accent);color:#fff;cursor:pointer; z-index:2;}
#adminLoginForm{max-width:100%; flex-direction:column; gap:10px; overflow:hidden; transition:0.5s;}
#adminLoginForm.hidden{max-height:0;padding:0;margin:0;opacity:0;}
#adminLoginForm.show{max-height:200px;opacity:1;margin-top:10px;padding-top:0;}
.pagination-controls button{margin:0 3px; font-size:0.9rem;}
@media screen and (max-width:600px){
  .row{flex-direction:column; gap:8px;}
  th,td{font-size:0.8rem; padding:8px;}
  input,select,button{font-size:1rem; padding:10px;}
}
</style>
</head>
<body>

<button class="dark-toggle" id="toggleDark">Dark Mode</button>
<div id="popUp" class="pop"></div>
<div id="toast" class="toast"></div>

<!-- Login Page -->
<div id="loginPage" class="container">
  <img src="sekolah-removebg-preview.png" alt="Logo Sekolah" style="width:80px;margin-bottom:12px;">
  <h1>Absensi Siswa</h1>
  <p class="muted">Masukkan kode siswa untuk absen:</p>
  <div class="row">
    <input id="loginCode" type="text" placeholder="Kode siswa..." autofocus>
    <button id="loginFocus" class="ghost">Fokus</button>
  </div>
  <p class="muted">Tekan <b>Enter</b> untuk absen.</p>
  <div class="row">
    <button id="showAdminFormBtn" class="ghost">Masuk Admin</button>
  </div>
  <div id="adminLoginForm" class="hidden row">
    <input id="adminPasswordInput" type="password" placeholder="Password admin">
    <button id="adminLoginBtn">Login</button>
  </div>
</div>

<!-- Admin Page -->
<div id="adminPage" class="container hidden">
  <img src="sekolah-removebg-preview.png" alt="Logo Sekolah" style="width:80px;margin-bottom:12px;">
  <h1>Admin Panel</h1>
  <p class="muted">Kelola siswa & laporan absensi</p>
  <div class="row">
    <button onclick="showTab('students')">Data Siswa</button>
    <button onclick="showTab('attendance')">Laporan Absensi</button>
    <button class="ghost" onclick="backToLogin()">Keluar</button>
  </div>

  <!-- Data Siswa -->
  <div id="tab-students">
    <h2>Data Siswa</h2>
    <div class="row">
      <input id="studentName" placeholder="Nama siswa">
      <input id="studentCode" placeholder="Kode siswa">
      <select id="studentClass">
        <option value="">Pilih Kelas</option>
        <option>1A</option><option>1B</option><option>2A</option><option>2B</option>
      </select>
      <button id="addStudentBtn">Tambah / Simpan</button>
    </div>
    <div class="row">
      <button id="exportStudentsBtn">Export Excel</button>
      <input type="file" id="importFile" style="display:none" accept=".xlsx">
      <button id="importBtn">Import Excel</button>
      <button id="downloadTemplateBtn">Download Template</button>
    </div>
    <div style="overflow-x:auto;">
      <table>
        <thead><tr><th>Nama</th><th>Kode</th><th>Kelas</th><th>Aksi</th></tr></thead>
        <tbody id="studentTable"></tbody>
      </table>
    </div>
    <div class="row pagination-controls" style="justify-content:center;margin-top:10px;">
      <button id="prevPage" class="ghost">Previous</button>
      <span id="pageInfo"></span>
      <button id="nextPage" class="ghost">Next</button>
    </div>
  </div>

  <!-- Laporan Absensi -->
  <div id="tab-attendance" class="hidden">
    <h2>Laporan Absensi</h2>
    <div class="row">
      <input type="text" id="searchAttendance" placeholder="Cari nama/kode...">
      <select id="filterClass"><option value="">Semua Kelas</option></select>
      <input type="date" id="startDate">
      <input type="date" id="endDate">
      <button id="exportAttendanceBtn">Export Excel</button>
    </div>
    <div style="overflow-x:auto;">
      <table>
        <thead><tr><th>Nama</th><th>Kode</th><th>Kelas</th><th>Waktu</th></tr></thead>
        <tbody id="attendanceTable"></tbody>
      </table>
    </div>
    <div class="row pagination-controls" id="attendancePaginationControls" style="justify-content:center;margin-top:12px;">
      <button id="prevAttendancePage" class="ghost">Previous</button>
      <span id="attendancePageInfo"></span>
      <button id="nextAttendancePage" class="ghost">Next</button>
    </div>
  </div>
</div>

<script>
// === DATA & VARIABLES ===
let students=JSON.parse(localStorage.getItem('students')||'[]');
let attendance=JSON.parse(localStorage.getItem('attendance')||'[]');
let editIndex=null;
let currentPage=1; const rowsPerPage=5;
let attendancePage=1; const attendanceRowsPerPage=10;
const adminPassword="admin123";

const loginPage=document.getElementById('loginPage');
const adminPage=document.getElementById('adminPage');
const loginCode=document.getElementById('loginCode');
const loginFocus=document.getElementById('loginFocus');
const showAdminFormBtn=document.getElementById('showAdminFormBtn');
const adminLoginForm=document.getElementById('adminLoginForm');
const adminPasswordInput=document.getElementById('adminPasswordInput');
const adminLoginBtn=document.getElementById('adminLoginBtn');
const searchAttendance=document.getElementById('searchAttendance');
const filterClass=document.getElementById('filterClass');
const toast=document.getElementById('toast');
const toggleDark=document.getElementById('toggleDark');
const studentTable=document.getElementById('studentTable');
const popUp=document.getElementById('popUp');
const startDate=document.getElementById('startDate');
const endDate=document.getElementById('endDate');

// === DARK MODE ===
toggleDark.addEventListener('click',()=>{ 
  if(document.documentElement.getAttribute('data-theme')==='dark') document.documentElement.removeAttribute('data-theme');
  else document.documentElement.setAttribute('data-theme','dark');
});

// === PULSE INPUT ===
window.addEventListener('load',()=>{ loginCode.focus(); loginCode.classList.add('animate-pulse'); setTimeout(()=>loginCode.classList.remove('animate-pulse'),3000); });

// === TOAST & POPUP & TTS ===
function showToast(msg,type='success'){ toast.textContent=msg; toast.style.backgroundColor= type==='success'? 'var(--success)':'var(--danger)'; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),2500); }
function showPop(success=true){ popUp.className='pop show '+(success?'success':'fail'); popUp.textContent= success?'✔':'✖'; setTimeout(()=>{ popUp.className='pop' },1000); }
function playBeep(ok=true){ const msg = new SpeechSynthesisUtterance(ok ? "OK" : "Maaf gagal"); msg.lang='id-ID'; window.speechSynthesis.speak(msg); }

// === ABSENSI SISWA ===
function markAttendance(code){
  const s = students.find(x=>x.code===code);
  if(!s){ showToast(`Kode ${code} tidak terdaftar!`,'danger'); playBeep(false); showPop(false); return; }
  const today = new Date().toLocaleDateString(); 
  if(attendance.some(a=>a.code===code && new Date(a.time).toLocaleDateString()===today)){
    showToast(`Siswa ${s.name} sudah absen hari ini!`,'danger'); playBeep(false); showPop(false); return;
  }
  const now = new Date();
  attendance.push({name:s.name,code:s.code,class:s.class,time:now.toLocaleString()});
  localStorage.setItem('attendance',JSON.stringify(attendance));
  showToast(`OK: ${s.name}`,'success'); playBeep(true); showPop(true);
}

// === LOGIN SISWA ===
loginCode.addEventListener('keydown',e=>{ if(e.key==='Enter'){ markAttendance(loginCode.value); loginCode.value=''; } });
loginFocus.addEventListener('click',()=>loginCode.focus());

// === ADMIN LOGIN ===
showAdminFormBtn.addEventListener('click',()=>{ adminLoginForm.classList.toggle('hidden'); adminLoginForm.classList.toggle('show'); adminPasswordInput.value=''; if(!adminLoginForm.classList.contains('hidden')) adminPasswordInput.focus(); });
adminPasswordInput.addEventListener('keydown',e=>{ if(e.key==='Enter') adminLoginBtn.click(); });
adminLoginBtn.addEventListener('click',()=>{ 
  if(adminPasswordInput.value===adminPassword){ loginPage.classList.add('hidden'); adminPage.classList.remove('hidden'); loadStudents(); loadAttendance(); populateFilterClass(); } 
  else{ showToast('Password salah','danger'); }
});

// === BACK TO LOGIN ===
function backToLogin(){ adminPage.classList.add('hidden'); loginPage.classList.remove('hidden'); loginCode.focus(); }

// === TAB SWITCH ===
function showTab(tab){ document.getElementById('tab-students').classList.add('hidden'); document.getElementById('tab-attendance').classList.add('hidden'); document.getElementById('tab-'+tab).classList.remove('hidden'); }

// === STUDENTS CRUD & PAGINATION ===
function loadStudents(){
  studentTable.innerHTML='';
  const start=(currentPage-1)*rowsPerPage;
  const end=start+rowsPerPage;
  const paged=students.slice(start,end);
  paged.forEach((s,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${s.name}</td><td>${s.code}</td><td>${s.class||''}</td>
      <td>
        <button onclick="editStudent(${start+i})" class="ghost">Edit</button>
        <button onclick="deleteStudent(${start+i})" class="ghost">Hapus</button>
      </td>`;
    studentTable.appendChild(tr);
  });
  document.getElementById('pageInfo').textContent=`Halaman ${currentPage}/${Math.ceil(students.length/rowsPerPage)||1}`;
}
document.getElementById('prevPage').addEventListener('click',()=>{ if(currentPage>1){currentPage--; loadStudents();} });
document.getElementById('nextPage').addEventListener('click',()=>{ if(currentPage<Math.ceil(students.length/rowsPerPage)){currentPage++; loadStudents();} });

function editStudent(i){ const s=students[i]; document.getElementById('studentName').value=s.name; document.getElementById('studentCode').value=s.code; document.getElementById('studentClass').value=s.class; editIndex=i; }
function deleteStudent(i){ if(confirm('Hapus siswa ini?')){ students.splice(i,1); localStorage.setItem('students',JSON.stringify(students)); loadStudents(); showToast('Siswa dihapus','success'); } }

document.getElementById('addStudentBtn').addEventListener('click',()=>{
  const name=document.getElementById('studentName').value.trim();
  const code=document.getElementById('studentCode').value.trim();
  const cls=document.getElementById('studentClass').value;
  if(!name||!code){ showToast('Nama & kode wajib diisi','danger'); return; }
  if(editIndex!==null){ students[editIndex]={name,code,class:cls}; editIndex=null; }
  else{ if(students.some(s=>s.code===code)){ showToast('Kode sudah ada','danger'); return; } students.push({name,code,class:cls}); }
  localStorage.setItem('students',JSON.stringify(students));
  loadStudents();
  document.getElementById('studentName').value=''; document.getElementById('studentCode').value=''; document.getElementById('studentClass').value='';
  showToast('Berhasil disimpan','success'); populateFilterClass();
});

// === FILTER CLASS ===
function populateFilterClass(){ const clsArr=[...new Set(students.map(s=>s.class).filter(c=>c))]; filterClass.innerHTML='<option value="">Semua Kelas</option>'; clsArr.forEach(c=>{ const opt=document.createElement('option'); opt.value=c; opt.textContent=c; filterClass.appendChild(opt); }); }

// === ATTENDANCE TABLE ===
function loadAttendance(){
  const search=searchAttendance.value.toLowerCase();
  const fClass=filterClass.value;
  const sDate=startDate.value?new Date(startDate.value):null;
  const eDate=endDate.value?new Date(endDate.value):null;
  let filtered=attendance.filter(a=>{
    let ok=true;
    if(search) ok=ok&&(a.name.toLowerCase().includes(search)||a.code.toLowerCase().includes(search));
    if(fClass) ok=ok&&(a.class===fClass);
    if(sDate) ok=ok&&(new Date(a.time)>=sDate);
    if(eDate) ok=ok&&(new Date(a.time)<=new Date(eDate.getFullYear(),eDate.getMonth(),eDate.getDate(),23,59,59));
    return ok;
  });
  const start=(attendancePage-1)*attendanceRowsPerPage;
  const end=start+attendanceRowsPerPage;
  const paged=filtered.slice(start,end);
  const tbody=document.getElementById('attendanceTable'); tbody.innerHTML='';
  paged.forEach(a=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${a.name}</td><td>${a.code}</td><td>${a.class||''}</td><td>${a.time}</td>`; tbody.appendChild(tr); });
  document.getElementById('attendancePageInfo').textContent=`Halaman ${attendancePage}/${Math.ceil(filtered.length/attendanceRowsPerPage)||1}`;
}

searchAttendance.addEventListener('input',()=>{ attendancePage=1; loadAttendance(); });
filterClass.addEventListener('change',()=>{ attendancePage=1; loadAttendance(); });
startDate.addEventListener('change',()=>{ attendancePage=1; loadAttendance(); });
endDate.addEventListener('change',()=>{ attendancePage=1; loadAttendance(); });
document.getElementById('prevAttendancePage').addEventListener('click',()=>{ if(attendancePage>1){attendancePage--; loadAttendance();} });
document.getElementById('nextAttendancePage').addEventListener('click',()=>{ attendancePage++; loadAttendance(); });

// === EXPORT / IMPORT ===
document.getElementById('exportStudentsBtn').addEventListener('click',()=>{ XLSX.utils.book_new(); const ws=XLSX.utils.json_to_sheet(students); XLSX.utils.book_append_sheet(XLSX.utils.book_new(),'Siswa',ws); XLSX.writeFile(XLSX.utils.book_new(),'students.xlsx'); });
document.getElementById('exportAttendanceBtn').addEventListener('click',()=>{ XLSX.utils.book_new(); const ws=XLSX.utils.json_to_sheet(attendance); XLSX.utils.book_append_sheet(XLSX.utils.book_new(),'Absensi',ws); XLSX.writeFile(XLSX.utils.book_new(),'attendance.xlsx'); });
document.getElementById('importBtn').addEventListener('click',()=>{ document.getElementById('importFile').click(); });
document.getElementById('importFile').addEventListener('change',e=>{ const file=e.target.files[0]; const reader=new FileReader(); reader.onload=(evt)=>{ const data=XLSX.read(evt.target.result,{type:'binary'}); const json=XLSX.utils.sheet_to_json(data.Sheets[data.SheetNames[0]]); students=students.concat(json); localStorage.setItem('students',JSON.stringify(students)); loadStudents(); populateFilterClass(); showToast('Import berhasil','success'); }; reader.readAsBinaryString(file); });

// === TEMPLATE DOWNLOAD ===
document.getElementById('downloadTemplateBtn').addEventListener('click',()=>{ const template=[{name:'Nama Siswa',code:'Kode Siswa',class:'Kelas'}]; const ws=XLSX.utils.json_to_sheet(template); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Template'); XLSX.writeFile(wb,'template.xlsx'); });

</script>
</body>
</html>

